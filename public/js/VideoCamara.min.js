document.addEventListener("DOMContentLoaded", function () {
    const video = document.getElementById('video');
    const canvas = document.getElementById('fotoCanvas');
    const capturar = document.getElementById('capturarFoto');
    const descargar = document.getElementById('descargarFoto');
    const reintentar = document.getElementById('reintentarFoto');
    let streamActual = null;

    function iniciarCamara() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    streamActual = stream;
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function (error) {
                    alert("No se pudo acceder a la cámara: " + error);
                });
        }
    }

    // Inicia cámara al cargar
    iniciarCamara();

    capturar.addEventListener('click', function () {
        const contexto = canvas.getContext('2d');
        contexto.drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL('image/jpeg');
        descargar.href = dataURL;
        descargar.style.display = 'inline-block';

        if (streamActual) {
            streamActual.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    });

    reintentar.addEventListener('click', function () {
        if (!video.srcObject) {
            iniciarCamara();
            descargar.style.display = 'none';
        }
    });
});
